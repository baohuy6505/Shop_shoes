<div class="container mt-4">
  <div class="row">
    <div class="{{#if product._id}}col-lg-12{{else}}col-lg-4{{/if}}">
      
      <!-- 1. Tiêu đề thay đổi dựa trên logic -->
      <h3 class="mb-3">{{#if product._id}}Chỉnh Sửa Sản Phẩm{{else}}Thêm Mới Sản Phẩm{{/if}}</h3>

      <div class="card shadow-sm mb-4">
        <div class="card-header">
          <!-- 2. Tiêu đề thẻ thay đổi -->
          <h5 class="mb-0">
            {{#if product._id}}Thông tin: {{product.productName}}{{else}}Điền thông tin sản phẩm{{/if}}
          </h5>
        </div>
        <div class="card-body">
          {{#if error}}
            {{#unless products}}
              <div class="alert alert-danger">{{error}}</div>
            {{/unless}}
          {{/if}}

          <!-- 
            3. Form action thay đổi dựa trên logic 
          -->
          <form
            method="POST"
            action="{{#if product._id}}/product/update/{{product._id}}{{else}}/product/create{{/if}}"
          >

            <div class="mb-3">
              <label for="productName" class="form-label">Tên Sản Phẩm</label>
              <input
                type="text"
                id="productName"
                name="productName"
                class="form-control"
                value="{{product.productName}}"
                required
              />
            </div>

            <div class="row g-3">
              <div class="col-md-6 mb-3">
                <label for="category" class="form-label">Loại Sản Phẩm</label>
                <select
                  id="category"
                  name="category"
                  class="form-select"
                  required
                >
                  <option value="">-- Chọn loại --</option>
                  {{#each categories}}
                    <option
                      value="{{this._id}}"
                      {{#if this.isSelected}}selected{{/if}}
                    >
                      {{this.categoryName}}
                    </option>
                  {{/each}}
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="price" class="form-label">Giá (VNĐ)</label>
                <input
                  type="number"
                  id="price"
                  name="price"
                  class="form-control"
                  value="{{product.price}}"
                  required
                />
              </div>
            </div>

            <div class="mb-3">
              <label for="imageUrl" class="form-label">Link Hình Ảnh</label>
              <input
                type="text"
                id="imageUrl"
                name="imageUrl"
                class="form-control"
                value="{{product.imageUrl}}"
              />
            </div>

            <div class="mb-3">
              <label for="description" class="form-label">Mô Tả</label>
              <textarea
                id="description"
                name="description"
                rows="3"
                class="form-control"
              >{{product.description}}</textarea>
            </div>

            <div>
              <!-- 5. Text của nút bấm thay đổi -->
              <button type="submit" class="btn btn-primary">
                {{#if product._id}}Lưu Thay Đổi{{else}}Thêm Mới{{/if}}
              </button>

              <!-- 6. Nút Hủy (luôn quay về trang chủ '/product') -->
              <a href="/product" class="btn btn-secondary">Hủy</a>
            </div>
          </form>
        </div>
      </div>
    </div> <!-- Kết thúc Cột 1 -->
    {{#if products}}
      <div class="col-lg-8">
        <h3 class="mb-3">Danh Sách Sản Phẩm</h3>

        <!-- Hiển thị thông báo (nếu có) -->
        {{#if message}}
          <div class="alert alert-success">{{message}}</div>
        {{/if}}
        {{#if error}}
          <div class="alert alert-danger">{{error}}</div>
        {{/if}}

        <div class="card shadow-sm">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th scope="col" style="width: 70px;">Ảnh</th>
                    <th scope="col">Tên Sản Phẩm</th>
                    <th scope="col">Loại</th>
                    <th scope="col">Giá</th>
                    <th scope="col" style="width: 120px;">Hành động</th>
                  </tr>
                </thead>
                <tbody>
                  {{#each products}}
                    <tr>
                      <td>
                        <img
                          src="{{this.imageUrl}}"
                          alt="{{this.productName}}"
                          onerror="this.src='https://placehold.co/100x100/eee/ccc?text=No+Image'"
                          style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;"
                        />
                      </td>
                      <td class="align-middle">{{this.productName}}</td>
                      <td class="align-middle">
                        {{!-- Kiểm tra xem category có tồn tại không trước khi truy cập --}}
                        {{#if this.category}}
                          {{this.category.categoryName}}
                        {{else}}
                          <span class="text-danger">N/A</span>
                        {{/if}}
                      </td>
                      <td class="align-middle">
                        {{this.price}}đ
                      </td>
                      <td class="align-middle">
                        <!-- Nút Sửa (Edit) -->
                        <a
                          href="/product/edit/{{this._id}}"
                          class="btn btn-sm btn-outline-primary me-1"
                          title="Sửa"
                        >
                          Sửa
                        </a>

                        <!-- Nút Xóa (Delete) -->
                        <form
                          method="POST"
                          action="/product/delete/{{this._id}}"
                          style="display: inline;"
                          onsubmit="return confirm('Bạn có chắc muốn xóa sản phẩm này?');"
                        >
                          <button
                            type="submit"
                            class="btn btn-sm btn-outline-danger"
                            title="Xóa"
                          >
                            Xóa
                          </button>
                        </form>
                      </td>
                    </tr>
                  {{else}}
                    <tr>
                      <td colspan="5" class="text-center p-4">
                        Chưa có sản phẩm nào.
                      </td>
                    </tr>
                  {{/each}}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    {{/if}} <!-- Kết thúc Cột 2 -->

  </div> <!-- Kết thúc .row -->
</div> <!-- Kết thúc .container -->