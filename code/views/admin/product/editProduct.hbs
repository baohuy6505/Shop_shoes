<div class="mt-4">
  <div class="row">
    <div class="{{#if product._id}}col-lg-12{{else}}col-lg-4{{/if}}">
      
      <h3 class="mb-3">{{#if product._id}}Chỉnh Sửa Sản Phẩm{{else}}Thêm Mới Sản Phẩm{{/if}}</h3>

      <div class="card shadow-sm mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            {{#if product._id}}Thông tin: {{product.productName}}{{else}}Điền thông tin sản phẩm{{/if}}
          </h5>
        </div>
        <div class="card-body">
          {{#if error}}
            {{#unless products}}
              <div class="alert alert-danger">{{error}}</div>
            {{/unless}}
          {{/if}}

          <form
            method="POST"
            action="{{#if product._id}}/Admin/Product/update/{{product._id}}{{else}}/Admin/Product/create{{/if}}"
            enctype="multipart/form-data"
          >

            <div class="mb-3">
              <label for="productName" class="form-label">Tên Sản Phẩm</label>
              <input
                type="text"
                id="productName"
                name="productName"
                class="form-control"
                value="{{product.productName}}"
                required
              />
            </div>

            <div class="row g-3">
              <div class="col-md-6 mb-3">
                <label for="category" class="form-label">Loại Sản Phẩm</label>
                <select
                  id="category"
                  name="category"
                  class="form-select"
                  required
                >
                  <option value="">-- Chọn loại --</option>
                  {{#each categories}}
                    <option
                      value="{{this._id}}"
                      {{#if this.isSelected}}selected{{/if}}
                    >
                      {{this.categoryName}}
                    </option>
                  {{/each}}
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="price" class="form-label">Giá (VNĐ)</label>
                <input
                  type="number"
                  id="price"
                  name="price"
                  class="form-control"
                  value="{{product.price}}"
                  required
                />
              </div>
            </div>

            <div class="mb-3">
              <label for="imageUrl" class="form-label">Hình Ảnh Đại Diện</label>
              <input
                type="file"
                id="imageUrl"
                name="imageUrl"
                class="form-control"
                
                {{!-- ĐÃ XÓA thuộc tính 'multiple' --}}
                
                accept="image/*"
                {{!-- ĐÃ SỬA TÊN HÀM gọi thành 'previewImage' --}}
                onchange="previewImage(this)" 
              />
            </div>
            
            {{!-- ĐÃ XÓA THẺ DIV LẶP LẠI BÊN NGOÀI --}}
            <div class="mt-2" id="image-preview-container" style="display: flex; gap: 10px; flex-wrap: wrap;">
              
              {{!-- LOGIC HIỂN THỊ ẢNH CŨ (CHỈ CÒN LÀ CHUỖI ĐƠN) --}}
              {{#if product.imageUrl}}
                  <div class="position-relative">
                      <img 
                          src="{{product.imageUrl}}" 
                          style="width:100px; height:100px; object-fit:cover; border: 1px solid #ddd; border-radius: 5px;"
                      >
                  </div>
              {{/if}} 
              
            </div>
            {{!-- ĐÃ XÓA THẺ ĐÓNG THỪA --}}

            <div class="mb-3">
              <label for="description" class="form-label">Mô Tả</label>
              <textarea
                id="description"
                name="description"
                rows="3"
                class="form-control"
              >{{product.description}}</textarea>
            </div>

            <div>
              <button type="submit" class="btn btn-primary">
                {{#if product._id}}Lưu Thay Đổi{{else}}Thêm Mới{{/if}}
              </button>

              <a href="/Admin/Product" class="btn btn-secondary">Hủy</a>
            </div>
          </form>
        </div>
      </div>
    </div> {{#if products}}
      <div class="col-lg-8">
        <h3 class="mb-3">Danh Sách Sản Phẩm</h3>

        {{#if message}}
          <div class="alert alert-success">{{message}}</div>
        {{/if}}
        {{#if error}}
          <div class="alert alert-danger">{{error}}</div>
        {{/if}}

        <div class="card shadow-sm">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th scope="col" style="width: 70px;">Ảnh</th>
                    <th scope="col">Tên Sản Phẩm</th>
                    <th scope="col">Loại</th>
                    <th scope="col">Giá</th>
                    <th scope="col" style="width: 120px;">Hành động</th>
                  </tr>
                </thead>
                <tbody>
                  {{#each products}}
                    <tr>
                      <td>
                        <img
                          src="{{this.imageUrl}}"
                          alt="{{this.productName}}"
                          onerror="this.src='https://placehold.co/100x100/eee/ccc?text=No+Image'"
                          style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;"
                        />
                      </td>
                      <td class="align-middle">{{this.productName}}</td>
                      <td class="align-middle">
                        {{!-- Kiểm tra xem category có tồn tại không trước khi truy cập --}}
                        {{#if this.category}}
                          {{this.category.categoryName}}
                        {{else}}
                          <span class="text-danger">N/A</span>
                        {{/if}}
                      </td>
                      <td class="align-middle fw-bold" style="color: red;">
                        {{formatCurrency this.price}}
                      </td>
                      <td class="align-middle">
                        <a
                          href="/Admin/Product/edit/{{this._id}}"
                          class="btn btn-sm btn-outline-primary me-1"
                          title="Sửa"
                        >
                          Sửa
                        </a>

                        <form
                          method="POST"
                          action="/Admin/Product/delete/{{this._id}}"
                          style="display: inline;"
                          onsubmit="return confirm('Bạn có chắc muốn xóa sản phẩm này?');"
                        >
                          <button
                            type="submit"
                            class="btn btn-sm btn-outline-danger"
                            title="Xóa"
                          >
                            Xóa
                          </button>
                        </form>
                      </td>
                    </tr>
                  {{else}}
                    <tr>
                      <td colspan="5" class="text-center p-4">
                        Chưa có sản phẩm nào.
                      </td>
                    </tr>
                  {{/each}}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    {{/if}} </div> </div> ---


<script>
    function previewImage(input) {
      var previewContainer = document.getElementById('image-preview-container');
      
      // Xóa tất cả ảnh xem trước cũ
      previewContainer.innerHTML = ''; 

      // Kiểm tra xem có file nào được chọn không
      if (input.files && input.files[0]) {
        var reader = new FileReader();

        reader.onload = function(event) {
          // Tạo thẻ img mới
          var imgElement = document.createElement('img');
          imgElement.setAttribute('src', event.target.result);
          
          // Style cho ảnh xem trước
          imgElement.style.width = '100px';
          imgElement.style.height = '100px';
          imgElement.style.objectFit = 'cover';
          imgElement.style.border = '1px solid #ddd';
          imgElement.style.borderRadius = '5px';

          // Tạo div bọc để giữ style cũ
          var imgWrapper = document.createElement('div');
          imgWrapper.classList.add('position-relative');
          imgWrapper.appendChild(imgElement);

          // Chỉ hiển thị ảnh mới nhất
          previewContainer.appendChild(imgWrapper);
        }

        // Đọc file đầu tiên (chỉ có 1 file)
        reader.readAsDataURL(input.files[0]);
      }
    }
</script>